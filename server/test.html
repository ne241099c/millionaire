<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å¤§å¯Œè±ª ãƒ‡ãƒãƒƒã‚°ãƒ«ãƒ¼ãƒ </title>
    <style>
        body { font-family: monospace; padding: 20px; background: #eee; }
        #game-area { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .card { 
            display: inline-block; border: 1px solid #999; background: #fff; 
            padding: 5px 10px; margin: 2px; cursor: pointer; border-radius: 4px; 
            user-select: none;
        }
        .card.selected { background: #e0f7fa; border-color: #00bcd4; font-weight: bold; }
        #log { height: 200px; overflow-y: scroll; border: 1px solid #ccc; background: #fff; padding: 10px; }
        .red { color: red; }
        .black { color: black; }
    </style>
</head>
<body>
    <h1>â™  å¤§å¯Œè±ª ãƒ‡ãƒãƒƒã‚°ãƒ«ãƒ¼ãƒ  â™¦</h1>

    <div style="margin-bottom: 10px;">
        <button onclick="startGame()">â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹ (Start)</button>
        <button onclick="sendPlay()">ğŸƒ é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™ (Play)</button>
    </div>

    <div id="game-area">
        <h3>å ´ (Table): <span id="table-cards">ãªã—</span></h3>
        <hr>
        <h3>ã‚ãªãŸã®æ‰‹æœ­ (Hand): <span id="hand-count">0</span>æš</h3>
        <div id="hand-container">
            (ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„)
        </div>
    </div>

    <div id="log"></div>

    <script>
        const socket = new WebSocket("ws://" + window.location.host + "/ws");
        
        // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’è¦šãˆã¦ãŠããƒªã‚¹ãƒˆ
        let selectedCards = [];

        // æ¥ç¶šãƒ­ã‚°
        socket.onopen = () => log("âœ… æ¥ç¶šã—ã¾ã—ãŸ");
        socket.onclose = () => log("âŒ åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        socket.onmessage = function(event) {
            const msg = JSON.parse(event.data);
            
            if (msg.type === "game_status") {
                renderGame(msg.payload);
            } else if (msg.type === "play_card") {
                // è‡ªåˆ†ã‚„ä»–äººãŒå‡ºã—ãŸæ™‚ã®é€šçŸ¥(ç¾åœ¨ã¯Broadcastã§ç”Ÿãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã‚‹ãŸã‚)
                log("ğŸ“© å—ä¿¡: " + event.data);
            } else {
                log("ğŸ“© å—ä¿¡: " + event.data);
            }
        };

        // ã‚²ãƒ¼ãƒ é–‹å§‹ã‚³ãƒãƒ³ãƒ‰
        function startGame() {
            socket.send(JSON.stringify({ type: "start_game", payload: {} }));
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™ã‚³ãƒãƒ³ãƒ‰
        function sendPlay() {
            if (selectedCards.length === 0) {
                alert("ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }
            // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦JSONã‚’ä½œã‚‹
            const payload = { cards: selectedCards };
            const msg = { type: "play_card", payload: payload };
            
            log("ğŸ“¤ é€ä¿¡: " + JSON.stringify(msg));
            socket.send(JSON.stringify(msg));
            
            // é¸æŠè§£é™¤
            selectedCards = [];
            renderHand(); // å†æç”»
        }

        // ç”»é¢æç”»
        let currentHand = []; // æœ€æ–°ã®æ‰‹æœ­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        
        function renderGame(status) {
            // å ´ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            const tableArea = document.getElementById("table-cards");
            if (status.table_cards && status.table_cards.length > 0) {
                tableArea.innerHTML = status.table_cards.map(c => cardStr(c)).join(" ");
            } else {
                tableArea.innerHTML = "ãªã—";
            }

            // æ‰‹æœ­è¡¨ç¤º
            document.getElementById("hand-count").innerText = status.hand ? status.hand.length : 0;
            const container = document.getElementById("hand-container");
            container.innerHTML = "";
            
            currentHand = status.hand || []; // æ›´æ–°
            
            currentHand.forEach((card, index) => {
                const div = document.createElement("div");
                div.className = "card " + (isSelected(card) ? "selected" : "");
                div.innerHTML = cardStr(card);
                
                // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ/è§£é™¤
                div.onclick = () => {
                    toggleSelect(card);
                    renderHand(); // è‰²ã‚’å¤‰ãˆã‚‹ãŸã‚ã«å†æç”»
                };
                container.appendChild(div);
            });
        }

        // æ‰‹æœ­ã ã‘å†æç”»(é¸æŠçŠ¶æ…‹ã®æ›´æ–°ç”¨)
        function renderHand() {
            const container = document.getElementById("hand-container");
            Array.from(container.children).forEach((div, i) => {
                const card = currentHand[i];
                if (isSelected(card)) div.classList.add("selected");
                else div.classList.remove("selected");
            });
        }

        // ä¾¿åˆ©é–¢æ•°
        function toggleSelect(card) {
            // ã™ã§ã«é¸æŠæ¸ˆã¿ãªã‚‰è§£é™¤ã€ãªã‘ã‚Œã°è¿½åŠ 
            const idx = selectedCards.findIndex(c => c.Suit === card.Suit && c.Rank === card.Rank);
            if (idx >= 0) {
                selectedCards.splice(idx, 1);
            } else {
                selectedCards.push(card);
            }
        }
        function isSelected(card) {
            return selectedCards.some(c => c.Suit === card.Suit && c.Rank === card.Rank);
        }

        // ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨ãƒãƒ¼ã‚¯ã‚’æ–‡å­—ã«ã™ã‚‹
        function cardStr(c) {
            const suits = ["â™ ", "â™¥", "â™¦", "â™£", "Joker"];
            const ranks = ["", "A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
            const color = (c.Suit === 1 || c.Suit === 2) ? "red" : "black";
            
            if (c.Suit === 4) return `<span class="red">Joker</span>`;
            return `<span class="${color}">${suits[c.Suit]}${ranks[c.Rank]}</span>`;
        }

        function log(text) {
            const el = document.getElementById("log");
            el.innerHTML += `<div>${text}</div>`;
            el.scrollTop = el.scrollHeight;
        }
    </script>
</body>
</html>